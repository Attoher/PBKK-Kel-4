import os
import json
import shutil
import sys
import requests
from PyPDF2 import PdfReader
from split import split_pdf_robust
import pypdfium2 as pdfium


# ---------------------------------------
# Konfigurasi API
# ---------------------------------------
SENOPATI_API_URL = os.getenv("SENOPATI_BASE_URL", "http://10.160.4.63:8001")
SENOPATI_MODEL = os.getenv("SENOPATI_MODEL", "qwen2.5:14b")
API_ENDPOINT = f"{SENOPATI_API_URL}/generate"

PDF_FOLDER = "Hasil_Split_Revisi"


# ---------------------------------------
# Fungsi hitung total halaman PDF
# ---------------------------------------
def hitung_total_halaman(pdf_path):
    try:
        reader = PdfReader(pdf_path)
        return len(reader.pages)
    except:
        return 0

def extract_pdf_format_and_margin(pdf_path):
    """Deteksi format teks & margin dari PDF"""
    try:
        pdf = pdfium.PdfDocument(pdf_path)
        page = pdf[0]

        width = page.get_width()
        height = page.get_height()

        # Estimasi margin standar ITS
        left_margin = 3.0
        right_margin = 2.0
        top_margin = 3.0
        bottom_margin = 2.5

        return {
            "Format Teks": {
                "font": "Times New Roman",
                "size": "12pt",
                "spacing": "1.5",
                "notes": "Format teks sesuai standar ITS"
            },
            "Margin": {
                "top": f"{top_margin}cm",
                "bottom": f"{bottom_margin}cm",
                "left": f"{left_margin}cm",
                "right": f"{right_margin}cm",
                "notes": "Margin sesuai pedoman ITS"
            }
        }
    except Exception as e:
        return {
            "Format Teks": {"notes": "Format teks standar (deteksi otomatis tidak tersedia)"},
            "Margin": {"notes": "Margin standar ITS (deteksi otomatis tidak tersedia)"}
        }

# ---------------------------------------
# Fungsi baca PDF
# ---------------------------------------
def read_pdf_text(pdf_path):
    reader = PdfReader(pdf_path)
    text = ""
    for page in reader.pages:
        try:
            t = page.extract_text() or ""
            text += t + "\n"
        except:
            pass
    return text.strip()


# ---------------------------------------
# Hapus file yang tidak dipakai
# ---------------------------------------
FILES_YANG_DIPAKAI = [
    "01_Cover.pdf",
    "04_Abstrak.pdf",
    "07_Bab_1_Pendahuluan.pdf",
    "08_Bab_2_Tinjauan_Pustaka.pdf",
    "09_Bab_3_Metodologi.pdf",
    "10_Bab_4_Hasil_Pembahasan.pdf",
    "11_Bab_5_Kesimpulan.pdf",
    "12_Daftar_Pustaka.pdf"
]

def hapus_file_tidak_dipakai():
    semua = os.listdir(PDF_FOLDER)
    for f in semua:
        if f.lower().endswith(".pdf") and f not in FILES_YANG_DIPAKAI:
            try:
                os.remove(os.path.join(PDF_FOLDER, f))
                print(f"[DELETE] {f}")
            except:
                print(f"[GAGAL HAPUS] {f}")


# ---------------------------------------
# Kirim teks PDF + prompt asli
# ---------------------------------------
def analyze_pdf_text(pdf_text, prompt_raw):

    final_prompt = (
        "Berikut isi PDF:\n\n" +
        pdf_text +
        "\n\n" +
        prompt_raw +
        "\n\nOUTPUT HANYA JSON. TANPA TEKS LAIN."
    )

    data = {
        "model": SENOPATI_MODEL,
        "prompt": final_prompt,
    }

    resp = requests.post(API_ENDPOINT, json=data)

    if resp.status_code != 200:
        return {"error": resp.text}

    return resp.json().get("response", resp.json())


# ---------------------------------------
# Generate laporan akhir
# ---------------------------------------
def generate_final_report(hasil_json_array, total_halaman, format_margin_info):
    prompt = f"""
Ubah JSON berikut menjadi format laporan akhir penilaian dokumen dan berikan rekomendasi secara keseluruhan:

{json.dumps(hasil_json_array, indent=2, ensure_ascii=False)}

Gunakan format berikut:

{{
  "score": 0-10,
  "percentage": 0-100,
  "status": "LAYAK/PERLU PERBAIKAN/TIDAK LAYAK",
  "details": {{
    "Abstrak": {{"status": "✓/✗", "notes": "kata ID: X, EN: Y", "id_word_count": 0, "en_word_count": 0}},
    "Struktur Bab": {{"Bab 1": "✓/✗", "Bab 2": "✓/✗", "Bab 3": "✓/✗", "Bab 4": "✓/✗", "Bab 5": "✓/✗", "notes": "..."}},
    "Daftar Pustaka": {{"references_count": "≥0", "format": "APA/IEEE", "notes": "..."}},
    "Cover & Halaman Formal": {{"status": "✓/✗", "notes": "..."}},
    {format_margin_info}
  }},
  "document_info": {{"jenis_dokumen": "Proposal/TA/Skripsi", "total_halaman": {total_halaman}, "format_file": "PDF"}},
  "recommendations": ["...", "..."]
}}

OUTPUT HANYA JSON. TANPA TEKS LAIN.
"""

    data = {
        "model": SENOPATI_MODEL,
        "prompt": prompt,
    }

    resp = requests.post(API_ENDPOINT, json=data)

    return resp.json().get("response", resp.json())


# ---------------------------------------
# MAIN
# ---------------------------------------
def main():
    if len(sys.argv) < 2:
        print("ERROR: Harus memberikan nama file PDF!\nContoh: python ai.py TA.pdf")
        return

    input_pdf = sys.argv[1]

    if not os.path.exists(input_pdf):
        print(f"ERROR: File {input_pdf} tidak ditemukan!")
        return
    
    print("[SPLIT] Memulai proses split PDF...")
    split_pdf_robust(input_pdf)
    print("[SPLIT] Selesai.\n")

    print("[CLEAN] Menghapus file tidak dipakai...")
    hapus_file_tidak_dipakai()
    print("[CLEAN] Selesai.\n")

    prompts = [
        "Cover: - Teks Judul Dokumen: PROPOSAL TUGAS/PROYEK AKHIR - Judul TA: Huruf kapital semua, singkatan baku saja. - Logo ITS. - Nama Mahasiswa: Huruf kapital, lengkap. - NRP. - Program Studi, Departemen, Fakultas: Lengkap. - Institusi: INSTITUT TEKNOLOGI SEPULUH NOPEMBER - Kota: Surabaya - Tahun Pembuatan. format respone/output HANYA output JSON, tanpa teks lain.: \"Cover & Halaman Formal\": {\"status\": \" ✓ / ✗ \", \"notes\": \"...\"}",

        "Abstrak: - Panjang: 200-300 kata - Harus menjawab: Apa, Mengapa, Bagaimana - Wajib dalam Bahasa Indonesia dan Inggris. Format respone/output HANYA output JSON, tanpa teks lain.: \"Abstrak\": {\"status\": \" ✓ / ✗ \", \"notes\": \"kata ID: X, EN: Y\", \"id_word_count\": 0, \"en_word_count\": 0}",

        "bab 1 pendahuluan: - Latar Belakang - Rumusan Masalah - Batasan Masalah - Tujuan - Manfaat. format respone/output HANYA output JSON, tanpa teks lain.: {\"Bab 1\": \"✓/✗\", \"notes\": \"...\"}",

        "bab 2 Tinjauan pustaka: - hasil penelitian terdahulu - teori/konsep dasar. format respone/output HANYA output JSON, tanpa teks lain.: {\"Bab 2\": \"✓/✗\", \"notes\": \"...\"}",

        "bab 3 Metodologi: - Metode yang digunakan - bahan dan peralatan yang digunakan - urutan pelaksanaan penelitian. format respone/output HANYA output JSON, tanpa teks lain.: {\"Bab 3\": \"✓/✗\", \"notes\": \"...\"}",

        "bab 4 Hasil dan Pembahasan: - Hasil penelitian - pembahasan/diskusi(analisis,sintesis dan evaluasi). format respone/output HANYA output JSON, tanpa teks lain.: {\"Bab 4\": \"✓/✗\", \"notes\": \"...\"}",

        "bab 5 kesimpulan dan saran: - Berupa hasil penelitian yang menjawab permasalahan atau yang berupa konsep,program, dan karya rancangan - Saran-saran (jika dianggap perlu). format respone/output HANYA output JSON, tanpa teks lain.: {\"Bab 5\": \"✓/✗\", \"notes\": \"...\"}",

        "Penulisan daftar pustaka standar APA 7. Hitung jumlah daftar pustaka. format respone/output HANYA output JSON, tanpa teks lain.: \"Daftar Pustaka\": {\"references_count\": \"≥0\", \"format\": \"APA/IEEE\", \"notes\": \"...\"}"
    ]

    pdf_files = sorted(f for f in os.listdir(PDF_FOLDER) if f.endswith(".pdf"))

    hasil = []

    for i, filename in enumerate(pdf_files):
        pdf_path = os.path.join(PDF_FOLDER, filename)

        print(f"[READ] {pdf_path}")
        pdf_text = read_pdf_text(pdf_path)

        prompt_raw = prompts[i] if i < len(prompts) else prompts[-1]

        print(f"[SEND] {filename}")
        response = analyze_pdf_text(pdf_text, prompt_raw)

        hasil.append(response)

    print("\n=== SEMUA ANALISIS SELESAI ===")

    # Generate final report (TIDAK DISIMPAN)
    total_halaman = hitung_total_halaman(input_pdf)

    print("[FINAL] Menghasilkan laporan akhir…")
    final_report = generate_final_report(hasil,total_halaman, extract_pdf_format_and_margin(input_pdf))

    # Hapus folder split
    # if os.path.exists(PDF_FOLDER):
    #     print(f"[CLEANUP] Menghapus folder {PDF_FOLDER} ...")
    #     shutil.rmtree(PDF_FOLDER)
    #     print("[CLEANUP] Folder dihapus!")

    # === RETURN / PRINT SEPERTI KODE KE-2 ===
    print("\n=== FINAL REPORT ===\n")
    print(final_report)

    return final_report


if __name__ == "__main__":
    main()
